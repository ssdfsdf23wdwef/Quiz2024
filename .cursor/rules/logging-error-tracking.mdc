---
description: "logging-error-tracking kurallarÄ±"
globs: 
alwaysApply: false
---
---
# Loglama, Durum AkÄ±ÅŸÄ± ve Hata Ä°zleme Rehberi

Bu projede loglama, durum akÄ±ÅŸÄ± ve hata izleme iÃ§in belirli standartlar kullanÄ±lmaktadÄ±r. Bu standartlar, uygulamanÄ±n davranÄ±ÅŸÄ±nÄ± anlamak, hatalarÄ± tespit etmek ve performans sorunlarÄ±nÄ± izlemek aÃ§Ä±sÄ±ndan kritik Ã¶neme sahiptir.

## Loglama Mimarisi

### Backend (NestJS) Loglama

NestJS'in kendi loglama sistemini geniÅŸleterek Ã¶zelleÅŸtirilmiÅŸ bir loglama mimarisi kullanÄ±lmaktadÄ±r:

- [backend/src/common/services/logger.service.ts](mdc:backend/src/common/services/logger.service.ts) - Merkezi loglama servisi
- [backend/src/common/services/flow-tracker.service.ts](mdc:backend/src/common/services/flow-tracker.service.ts) - AkÄ±ÅŸ izleme servisi
- [backend/src/common/filters/exception.filter.ts](mdc:backend/src/common/filters/exception.filter.ts) - Merkezi hata iÅŸleme

### LoggerService

- Singleton pattern ile implementasyon
- FarklÄ± log seviyeleri: `error`, `warn`, `info`, `debug`, `verbose`
- Log mesajlarÄ± yapÄ±landÄ±rÄ±labilir hedeflere (dosya, konsol, MongoDB) yazÄ±labilir
- Hata tiplerine gÃ¶re ayrÄ±ntÄ±lÄ± loglama
- JSON formatÄ±nda yapÄ±landÄ±rÄ±lmÄ±ÅŸ loglar
- Ortam deÄŸiÅŸkenlerine gÃ¶re log seviyesi ayarlama

```typescript
// LoggerService kullanÄ±m Ã¶rneÄŸi
@Injectable()
export class CoursesService {
  private readonly logger = new LoggerService(CoursesService.name);
  
  async findAll(userId: string): Promise<Course[]> {
    this.logger.log('Kurslar getiriliyor', { userId });
    try {
      const courses = await this.coursesRepository.findByUserId(userId);
      this.logger.log('Kurslar baÅŸarÄ±yla getirildi', { 
        userId, 
        courseCount: courses.length 
      });
      return courses;
    } catch (error) {
      this.logger.error('Kurslar getirilirken hata oluÅŸtu', { 
        userId, 
        error: error.message,
        stack: error.stack
      });
      throw error;
    }
  }
}

## Loglama Servisleri

### LoggerService

- [backend/src/common/services/logger.service.ts](mdc:backend/src/common/services/logger.service.ts) - Merkezi loglama servisi
- FarklÄ± log seviyeleri: `error`, `warn`, `info`, `debug`
- Log mesajlarÄ± dosyaya yazÄ±lÄ±r, terminale yazdÄ±rÄ±lmaz
- Hata tiplerine gÃ¶re ayrÄ±ntÄ±lÄ± loglama
- JSON formatÄ±nda yapÄ±landÄ±rÄ±lmÄ±ÅŸ loglar

```typescript
// LoggerService kullanÄ±m Ã¶rneÄŸi
this.logger.info(
  'Kurslar baÅŸarÄ±yla getirildi',
  'CoursesService.findAll',
  __filename,
  146,
  { userId, courseCount: courses.length },
);

// Hata durumunda
this.logger.logError(error, 'CoursesService.findAll', {
  userId,
  additionalInfo: 'Kurslar getirilirken hata oluÅŸtu',
});
```

### FlowTrackerService

- [backend/src/common/services/flow-tracker.service.ts](mdc:backend/src/common/services/flow-tracker.service.ts) - AkÄ±ÅŸ izleme servisi
- Program akÄ±ÅŸÄ±nÄ± terminale yazdÄ±rÄ±r, dosyaya yazmaz
- Emoji ve renklerle zenginleÅŸtirilmiÅŸ terminal Ã§Ä±ktÄ±sÄ±
- FarklÄ± iÅŸlem tipleri: metot baÅŸlangÄ±Ã§/bitiÅŸ, adÄ±m, API istekleri, veritabanÄ± iÅŸlemleri
- Performans izleme iÃ§in Ã§alÄ±ÅŸma sÃ¼resi Ã¶lÃ§Ã¼mÃ¼

```typescript
// FlowTrackerService kullanÄ±m Ã¶rneÄŸi
this.flowTracker.trackStep('Kurslar getiriliyor', 'CoursesService');
this.flowTracker.trackMethodStart('findAll', 'CoursesService', { userId });
this.flowTracker.trackMethodEnd('findAll', 'CoursesService', executionTime);
this.flowTracker.trackApiRequest('GET', '/api/courses', 'CoursesController');
this.flowTracker.trackDbOperation('QUERY', 'courses', 25, 'CoursesService');
```

## LogMethod DekoratÃ¶rÃ¼

- [backend/src/common/decorators/log-method.decorator.ts](mdc:backend/src/common/decorators/log-method.decorator.ts)
- MetotlarÄ±n otomatik olarak loglanmasÄ± iÃ§in kullanÄ±lÄ±r
- BaÅŸlangÄ±Ã§, bitiÅŸ, parametreler ve dÃ¶nÃ¼ÅŸ deÄŸerlerini loglar
- Ã‡alÄ±ÅŸma sÃ¼resini Ã¶lÃ§er
- Opsiyonel yapÄ±landÄ±rma ile esneklik saÄŸlar

```typescript
// LogMethod dekoratÃ¶rÃ¼ kullanÄ±mÄ±
@LogMethod({ trackParams: true, trackResult: true })
async findAll(userId: string): Promise<Course[]> {
  // Metot iÃ§eriÄŸi
}

// Parametre izlemeyi kapatma
@LogMethod({ trackParams: false })
async processPayment(paymentInfo: PaymentInfo): Promise<void> {
  // Hassas bilgi iÃ§eren metot
}
```

## Loglama YardÄ±mcÄ± FonksiyonlarÄ±

- [backend/src/common/utils/logger.utils.ts](mdc:backend/src/common/utils/logger.utils.ts)
- KolaylaÅŸtÄ±rÄ±lmÄ±ÅŸ loglama iÃ§in yardÄ±mcÄ± fonksiyonlar
- Hata ve akÄ±ÅŸ loglamasÄ± iÃ§in merkezi iÅŸlevler
- Stack trace ve Ã§aÄŸÄ±ran metot bilgisini otomatik Ã§Ä±karma
- BÃ¼yÃ¼k nesneleri gÃ¼venli bir ÅŸekilde loglamak iÃ§in `safeStringify` fonksiyonu

```typescript
// YardÄ±mcÄ± fonksiyonlarÄ± doÄŸrudan kullanma
import { logError, logFlow, safeStringify } from '../common/utils/logger.utils';

logError(error, 'methodName', __filename, __line, { context: 'additional info' });
logFlow('Ä°ÅŸlem baÅŸlatÄ±lÄ±yor', 'ContextName');
const safeObj = safeStringify(largeObject, 500); // 500 karakter ile sÄ±nÄ±rla
```

## Durum AkÄ±ÅŸÄ± Ä°zleme (State Flow Tracking)

Uygulama iÃ§indeki durum deÄŸiÅŸimlerini ve veri akÄ±ÅŸÄ±nÄ± izlemek, davranÄ±ÅŸlarÄ± anlamak ve hatalarÄ± bulmak iÃ§in kritiktir. Frontend ve backend'de farklÄ± durum izleme stratejileri uygulanmaktadÄ±r.

### Backend Durum AkÄ±ÅŸÄ± Ä°zleme

1. **Ä°ÅŸlem AÅŸamalarÄ±nÄ± Ä°zleme:**
```typescript
// Ä°ÅŸlem baÅŸlangÄ±cÄ±
this.flowTracker.trackStep('KullanÄ±cÄ± doÄŸrulama baÅŸlatÄ±ldÄ±', 'AuthService');

// Ara aÅŸamalar
this.flowTracker.trackStep('KullanÄ±cÄ± veritabanÄ±nda bulundu', 'AuthService');
this.flowTracker.trackStep('Token oluÅŸturuluyor', 'AuthService');

// Ä°ÅŸlem sonucu
this.flowTracker.trackStep('KullanÄ±cÄ± baÅŸarÄ±yla doÄŸrulandÄ±', 'AuthService');
```

2. **Durum DeÄŸiÅŸimlerini Loglama:**
```typescript
this.logger.info(
  `Ã–ÄŸrenme hedefi durumu: ${oldStatus} -> ${newStatus}`,
  'LearningTargetsService.updateStatus',
  __filename, 
  lineNumber,
  { targetId, oldStatus, newStatus, userId }
);
```

3. **Veri AkÄ±ÅŸÄ±nÄ± Ä°zleme:**
```typescript
// Veri normalize edildiÄŸinde
this.flowTracker.trackStep('Belgeden konular Ã§Ä±karÄ±lÄ±yor', 'DocumentsService');
this.logger.debug(
  `${extractedTopics.length} konu tespit edildi`,
  'DocumentsService.extractTopics',
  __filename,
  lineNumber,
  { documentId, topicCount: extractedTopics.length }
);
```

### Frontend Durum AkÄ±ÅŸÄ± Ä°zleme (Zustand ile)

- [frontend/src/store/middlewares/logger.middleware.ts](mdc:frontend/src/store/middlewares/logger.middleware.ts)
- Store durum deÄŸiÅŸimlerini konsolda izlemek iÃ§in middleware kullanÄ±mÄ±
- Durum geÃ§iÅŸlerini gÃ¶sterme ve deÄŸiÅŸiklikleri vurgulama
- Performans etkisi nedeniyle sadece development modunda aktif olmalÄ±

```typescript
// Zustand middleware Ã¶rneÄŸi
const loggerMiddleware = (config) => (set, get, api) => config(
  (...args) => {
    const prevState = get();
    set(...args);
    const nextState = get();
    console.log('ğŸ”„ Durum deÄŸiÅŸti:', {
      prev: prevState,
      next: nextState,
      action: args[0],
    });
  },
  get,
  api
);

// Store tanÄ±mÄ±nda kullanÄ±mÄ±
export const useAuthStore = create(
  process.env.NODE_ENV === 'development' 
    ? loggerMiddleware(authStoreImpl) 
    : authStoreImpl
);
```

## Loglama StandartlarÄ±

1. **Her serviste logger ve flowTracker nesneleri tanÄ±mlanmalÄ±dÄ±r:**
```typescript
private readonly logger: LoggerService;
private readonly flowTracker: FlowTrackerService;

constructor() {
  this.logger = LoggerService.getInstance();
  this.flowTracker = FlowTrackerService.getInstance();
}
```

2. **TÃ¼m public metotlarda `@LogMethod` dekoratÃ¶rÃ¼ kullanÄ±lmalÄ±dÄ±r.**

3. **Ä°ÅŸlem adÄ±mlarÄ± flowTracker.trackStep ile izlenmelidir:**
```typescript
this.flowTracker.trackStep(`${id} ID'li kurs getiriliyor`, 'CoursesService');
```

4. **Ã–nemli iÅŸlemler info seviyesinde loglanmalÄ±dÄ±r:**
```typescript
this.logger.info(`${id} ID'li kurs baÅŸarÄ±yla gÃ¼ncellendi`, 'method', __filename, lineNumber);
```

5. **TÃ¼m hatalar catch bloklarÄ±nda loglanmalÄ±dÄ±r:**
```typescript
try {
  // Ä°ÅŸlem
} catch (error) {
  this.logger.logError(error, 'CoursesService.method', { additionalInfo: '...' });
  throw error;
}
```

6. **Hassas bilgiler kesinlikle loglanmamalÄ±dÄ±r:** 
   Åifreler, tokenlar, kiÅŸisel bilgiler vs. loglara dahil edilmemelidir.

7. **API istekleri ve yanÄ±tlarÄ± izlenmelidir:**
```typescript
// Ä°stek baÅŸlangÄ±cÄ±
this.flowTracker.trackApiRequest('POST', '/api/auth/login', 'AuthController');

// Ä°stek sonucu
this.flowTracker.trackApiResponse('POST', '/api/auth/login', 200, responseTime, 'AuthController');
```

8. **VeritabanÄ± iÅŸlemleri izlenmelidir:**
```typescript
const startTime = Date.now();
const result = await this.firebaseService.findMany(...);
const endTime = Date.now();
this.flowTracker.trackDbOperation('QUERY', 'courses', endTime - startTime, 'CoursesService');
```

9. **BÃ¼yÃ¼k nesneler loglanÄ±rken `safeStringify` kullanÄ±lmalÄ±dÄ±r:**
```typescript
this.logger.debug(
  'API yanÄ±tÄ± alÄ±ndÄ±',
  'ApiService.fetch',
  __filename,
  lineNumber,
  { response: safeStringify(response, 500) }
);
```

10. **Durum deÄŸiÅŸimleri aÃ§Ä±kÃ§a belirtilmelidir:**
```typescript
this.logger.info(
  `Quiz durumu deÄŸiÅŸti: ${oldStatus} -> ${newStatus}`,
  'QuizzesService.updateStatus',
  __filename,
  lineNumber,
  { quizId, oldStatus, newStatus }
);
```

## Hata YÃ¶netimi

1. **Hata mesajlarÄ± TÃ¼rkÃ§e olmalÄ±dÄ±r.**

2. **KullanÄ±cÄ±ya gÃ¶sterilecek hatalar ve iÃ§ hatalar ayrÄ±lmalÄ±dÄ±r:**
```typescript
// KullanÄ±cÄ±ya gÃ¶sterilecek hata
throw new BadRequestException('GeÃ§ersiz dosya formatÄ±. LÃ¼tfen PDF veya DOCX dosyasÄ± yÃ¼kleyin.');

// Ä°Ã§ hata (loglanÄ±r ama kullanÄ±cÄ±ya detaylar gÃ¶sterilmez)
this.logger.error(
  `Dosya iÅŸlenirken hata oluÅŸtu: ${error.message}`,
  'DocumentsService.processFile',
  __filename,
  lineNumber,
  { fileId, error: error.stack }
);
throw new InternalServerErrorException('Dosya iÅŸlenemedi. LÃ¼tfen daha sonra tekrar deneyin.');
```

3. **TÃ¼m beklenmeyen hatalar loglanmalÄ±dÄ±r.**

4. **HTTP yanÄ±tlarÄ±nda anlamlÄ± hata kodlarÄ± kullanÄ±lmalÄ±dÄ±r:**
   - 400: Bad Request - Ä°stemci hatasÄ±
   - 401: Unauthorized - Kimlik doÄŸrulama gerekli
   - 403: Forbidden - Yetkilendirme hatasÄ±
   - 404: Not Found - Kaynak bulunamadÄ±
   - 409: Conflict - Kaynak Ã§akÄ±ÅŸmasÄ±
   - 422: Unprocessable Entity - DoÄŸrulama hatasÄ±
   - 500: Internal Server Error - Sunucu hatasÄ±

5. **Ã–zel hata filtreleri kullanÄ±lmalÄ±dÄ±r:**
   - [backend/src/common/filters/http-exception.filter.ts](mdc:backend/src/common/filters/http-exception.filter.ts)
   - TÃ¼m hatalar tutarlÄ± bir formatta istemciye dÃ¶ndÃ¼rÃ¼lmelidir
   - Hata detaylarÄ± production ortamÄ±nda gizlenmelidir

## Loglama ve Ä°zleme Best Practices

1. **GeliÅŸtirme aÅŸamasÄ±nda ayrÄ±ntÄ±lÄ± loglar kullanÄ±n, production'da kritik loglarÄ± etkinleÅŸtirin.**

2. **Her Ã¶nemli iÅŸlem iÃ§in hem baÅŸlangÄ±Ã§ hem de bitiÅŸ mesajlarÄ± loglanmalÄ±dÄ±r.**

3. **Log mesajlarÄ± anlamlÄ± ve baÄŸlamÄ± yansÄ±tmalÄ±dÄ±r. "Hata oluÅŸtu" gibi belirsiz mesajlardan kaÃ§Ä±nÄ±n.**

4. **Loglarda tutarlÄ± format kullanÄ±n: tarih-saat, loglama seviyesi, mesaj, baÄŸlam, dosya/satÄ±r bilgisi.**

5. **Ä°ÅŸlem tanÄ±mlayÄ±cÄ±larÄ± (correlation IDs) ile iliÅŸkili loglarÄ± gruplandÄ±rÄ±n:**
```typescript
// Ä°stek baÅŸÄ±nda correlation ID oluÅŸtur
const correlationId = uuid();
this.logger.info(
  'Ä°stek alÄ±ndÄ±',
  'RequestMiddleware',
  __filename,
  lineNumber,
  { correlationId, path: req.path, method: req.method }
);

// TÃ¼m loglara correlation ID ekle
this.logger.info(
  'Ä°ÅŸlem tamamlandÄ±',
  'Service.method',
  __filename,
  lineNumber,
  { correlationId, result: 'success' }
);
```

6. **Metrikler ve loglama arasÄ±nda baÄŸlantÄ± kurun - aynÄ± correlation ID'leri kullanÄ±n.**



